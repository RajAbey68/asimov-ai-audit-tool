<!DOCTYPE html>
<html>
<head>
  <title>ASIMOV AI Governance Audit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Montserrat:wght@600;700&display=swap" rel="stylesheet">
  <style>
    /* ASIMOV-AI Style Guide v1.0 
       Primary: #00C9A7 (Electric Teal)
       Secondary: #1C2541 (Midnight Blue)
       Background: #F5F6FA (Light Gray Blue)
       Fonts: Inter & Montserrat
    */
    
    /* Base styles */
    body {
      font-family: 'Inter', 'Roboto', sans-serif;
      max-width: 960px;
      margin: 0 auto;
      padding: 20px;
      line-height: 1.6;
      background-color: #F5F6FA;
      color: #1C2541;
    }
    
    h1, h2, h3 {
      font-family: 'Montserrat', 'Inter', sans-serif;
      color: #1C2541;
      border-bottom: 1px solid #ddd;
      padding-bottom: 10px;
      letter-spacing: 0.01em;
    }
    
    /* Card components */
    .card {
      border: 1px solid #eaeaea;
      border-radius: 8px;
      padding: 25px;
      margin-bottom: 30px;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }
    
    /* Progress tracking */
    .progress-container {
      width: 100%;
      background-color: #e0e0e0;
      border-radius: 8px;
      margin: 25px 0;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 30px;
      background-color: #00C9A7;
      border-radius: 4px;
      text-align: right;
      color: white;
      padding-right: 10px;
      line-height: 30px;
      font-size: 14px;
      font-weight: 600;
    }
    
    /* Control information */
    .control-info {
      margin-bottom: 30px;
      line-height: 1.6;
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
    }
    
    /* Meta tags */
    .meta-info {
      display: flex;
      flex-wrap: wrap;
      margin-bottom: 20px;
      gap: 8px;
    }
    
    .meta-tag {
      background-color: #00C9A7; /* Primary Teal for most tags */
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 0.9em;
      font-weight: 600;
    }
    
    /* Risk-based tag colors */
    .meta-tag.risk-high {
      background-color: #E63946; /* Red for High Risk */
    }
    
    .meta-tag.risk-general {
      background-color: #6C757D; /* Slate Grey for General Risk */
    }
    
    /* Sector and Region tags */
    .meta-tag.sector, .meta-tag.region {
      background-color: #1C2541; /* Navy Blue for Sector/Region */
    }
    
    form {
      margin-top: 20px;
    }
    
    /* Navigation */
    .nav-links {
      margin-bottom: 25px;
    }
    
    .nav-links a {
      margin-right: 20px;
      color: #00C9A7;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.2s;
    }
    
    .nav-links a:hover {
      color: #00B096;
      text-decoration: none;
    }
    
    /* Buttons */
    button {
      background-color: #00C9A7;
      color: white;
      padding: 10px 18px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
    }
    
    button:hover {
      background-color: #009e87; /* Darker teal on hover */
      box-shadow: 0 2px 6px rgba(0, 201, 167, 0.3);
    }
    
    button.secondary {
      background-color: transparent;
      border: 2px solid #1C2541;
      color: #1C2541;
    }
    
    button.secondary:hover {
      background-color: rgba(0, 201, 167, 0.1); /* Light teal background */
      border-color: #00C9A7;
      color: #1C2541;
    }
    
    button.danger {
      background-color: #E63946; /* Red for danger actions */
      color: white;
    }
    
    button.danger:hover {
      background-color: #d32f3a; /* Darker red on hover */
      box-shadow: 0 2px 6px rgba(230, 57, 70, 0.3);
    }
    
    button.with-spinner {
      position: relative;
      padding-right: 42px;
    }
    
    /* Loading spinner */
    .spinner {
      border: 4px solid #F5F6FA;
      border-top: 4px solid #00C9A7;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: insight-spin 1s linear infinite;
      display: inline-block;
      margin-left: 10px;
      vertical-align: middle;
    }
    
    /* Framework section */
    .framework-section {
      margin-top: 20px;
      padding: 16px;
      background-color: rgba(0, 201, 167, 0.1);
      border-radius: 6px;
      border-left: 4px solid #00C9A7;
    }
    
    /* Insight container */
    .insight-container {
      background-color: white;
      padding: 22px;
      border-left: 4px solid #00C9A7;
      margin-bottom: 22px;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
      line-height: 1.6;
    }
    
    .control-dialog {
      background-color: white;
      padding: 22px;
      border-radius: 8px;
      margin-bottom: 25px;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    }
    
    .button-group {
      display: flex;
      gap: 12px;
    }
    
    /* Form elements with improved styling */
    select, textarea {
      width: 100%;
      padding: 12px;
      margin-bottom: 18px;
      border: 2px solid #00C9A7;
      border-radius: 6px;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
      color: #1C2541;
      appearance: none;
      background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%2300C9A7' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right 1rem center;
      background-size: 1em;
    }
    
    select:hover, textarea:hover {
      border-color: #00B096;
      box-shadow: 0 0 0 3px rgba(0, 201, 167, 0.1);
    }
    
    select:focus, textarea:focus {
      outline: none;
      border-color: #00B096;
      box-shadow: 0 0 0 3px rgba(0, 201, 167, 0.2);
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #1C2541;
    }
    
    /* Modal overlay for confirmations */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(28, 37, 65, 0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    
    .modal-content {
      background: white;
      padding: 25px;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    }
    
    /* Animations */
    @keyframes insight-spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
      body {
        padding: 15px;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .meta-info {
        flex-direction: column;
        gap: 5px;
      }
      
      .meta-tag {
        display: inline-block;
        margin-bottom: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="nav-links">
    <a href="/">Home</a>
    <a href="/audits">View Previous Audits</a>
  </div>
  
  <h1>AI Governance Audit</h1>
  
  <div class="progress-container">
    <div class="progress-bar" style="width: {{ progress.percentage }}%">{{ progress.percentage }}%</div>
  </div>
  
  <p>Question {{ question_index + 1 }} of {{ progress.total }}</p>
  
  <div class="card">
    <h2>{{ control.control_name }}</h2>
    
    <div class="meta-info">
      {% if control.category %}
      <span class="meta-tag">{{ control.category }}</span>
      {% endif %}
      
      {% if control.risk_level %}
        {% if control.risk_level == "High" %}
        <span class="meta-tag risk-high">Risk: {{ control.risk_level }}</span>
        {% else %}
        <span class="meta-tag risk-general">Risk: {{ control.risk_level }}</span>
        {% endif %}
      {% endif %}
      
      <!-- Force display sector and region tags -->
      <span class="meta-tag sector" style="background-color: #1C2541; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">üè¢ Sector: {% if sector == "General" %}All Sectors{% else %}{{ sector or "All Sectors" }}{% endif %}</span>
      
      <span class="meta-tag region" style="background-color: #1C2541; color: white; padding: 4px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600;">üåç Region: {% if region == "Global" %}All Regions{% else %}{{ region or "All Regions" }}{% endif %}</span>
    </div>
    
    <form action="{{ url_for('submit', session_id=session_id, question_index=question_index) }}" method="post">
      <input type="hidden" name="control_id" value="{{ control.id }}">
      <input type="hidden" name="question_text" value="{{ control.description }}">
      <input type="hidden" name="category" value="{{ control.category }}">
      
      <!-- Dialog boxes at top -->
      <div style="background-color: white; padding: 22px; border-radius: 8px; margin-bottom: 25px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
          <div style="flex: 3; min-width: 280px;">
            <label for="response_score" style="display: inline-block; margin-right: 10px; font-weight: 600; color: #1C2541;">Compliance Level:</label>
            <select name="response_score" required style="width: auto; display: inline-block; padding: 10px 14px; border-radius: 6px; border: 1px solid #ddd; color: #1C2541; font-family: 'Inter', sans-serif;">
              <option value="4" {% if existing_response and existing_response.response_score == 4 %}selected{% endif %}>Always (Fully Compliant)</option>
              <option value="3" {% if existing_response and existing_response.response_score == 3 %}selected{% endif %}>Often (Mostly Compliant)</option>
              <option value="2" {% if existing_response and existing_response.response_score == 2 %}selected{% endif %}>Occasionally (Partially Compliant)</option>
              <option value="1" {% if existing_response and existing_response.response_score == 1 %}selected{% endif %}>Rarely/Never (Non-Compliant)</option>
            </select>
          </div>
          <div style="display: flex; gap: 12px;">
            <div class="dropdown" style="position: relative; display: inline-block;">
              <button type="button" class="secondary" style="font-size: 15px; padding: 10px 18px; background-color: transparent; border: 2px solid #1C2541; color: #1C2541; border-radius: 6px; cursor: pointer; font-weight: 600;">Export</button>
              <div class="dropdown-content" style="display: none; position: absolute; right: 0; background-color: white; min-width: 200px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.1); z-index: 1; border-radius: 8px; overflow: hidden; margin-top: 5px;">
                <a href="{{ url_for('export_pdf', session_id=session_id, question_index=question_index, format='text') }}" style="color: #1C2541; padding: 12px 16px; text-decoration: none; display: block; font-weight: 500; border-bottom: 1px solid #eee;">Text (Email-friendly)</a>
                <a href="{{ url_for('export_pdf', session_id=session_id, question_index=question_index, format='csv') }}" style="color: #1C2541; padding: 12px 16px; text-decoration: none; display: block; font-weight: 500; border-bottom: 1px solid #eee;">CSV (Analysis-friendly)</a>
                <a href="{{ url_for('export_pdf', session_id=session_id, question_index=question_index) }}" style="color: #1C2541; padding: 12px 16px; text-decoration: none; display: block; font-weight: 500;">HTML (Print-friendly)</a>
              </div>
            </div>
            <button type="button" id="addToRoadmapBtn" style="font-size: 15px; padding: 10px 18px; background-color: #1C2541; color: white; border-radius: 6px; margin-right: 10px; cursor: pointer; font-weight: 600; transition: all 0.2s;">
                <i class="fas fa-route"></i> Add to Roadmap
            </button>
            <button type="submit" name="next_question" value="true" style="font-size: 15px; padding: 10px 22px; background-color: #00C9A7; color: white; border-radius: 6px; font-weight: 600; transition: all 0.2s;">Next</button>
          </div>
          
          <script>
            // Add event listener to show/hide dropdown
            document.addEventListener('DOMContentLoaded', function() {
              const dropdownBtn = document.querySelector('.dropdown button');
              const dropdownContent = document.querySelector('.dropdown-content');
              
              dropdownBtn.addEventListener('click', function() {
                dropdownContent.style.display = dropdownContent.style.display === 'block' ? 'none' : 'block';
              });
              
              // Close the dropdown if clicked outside
              window.addEventListener('click', function(event) {
                if (!event.target.matches('.dropdown button')) {
                  dropdownContent.style.display = 'none';
                }
              });
            });
          </script>
        </div>
        
        <!-- Life-Wise Insight section with refresh button -->
        <div id="insightContainer" style="background-color: white; padding: 22px; border-left: 4px solid #00C9A7; margin-bottom: 22px; border-radius: 8px; box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06); line-height: 1.6;">
          {% if insight %}
          <div id="insightContent">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 15px;">
              <div>
                <h3 style="margin-top: 0; margin-bottom: 10px; color: #1C2541; font-family: 'Montserrat', sans-serif; font-size: 18px;">Life-Wise Insight</h3>
                <p style="margin-top: 0; font-size: 16px; line-height: 1.6;">{{ insight }}</p>
              </div>
              <button id="refreshInsightBtn" type="button" style="background-color: #00C9A7; border: none; color: white; padding: 8px 14px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; white-space: nowrap; flex-shrink: 0; transition: all 0.2s;">
                Generate New Insight
              </button>
            </div>
            <p id="insightSuccess" style="margin-top: 12px; color: #00C9A7; font-size: 14px; display: none;">
              ‚úÖ <em>Insight generated based on selected framework, sector, and region.</em>
            </p>
          </div>
          {% endif %}
          
          <!-- Loading state (hidden by default) -->
          <div id="insightLoading" style="display: none; text-align: center; padding: 20px 0;">
            <div class="spinner" style="display: inline-block; width: 30px; height: 30px; border: 3px solid #f3f3f3; border-top: 3px solid #00C9A7; border-radius: 50%; animation: insight-spin 1s linear infinite;"></div>
            <p style="color: #00C9A7; margin-top: 12px; font-weight: 500;">
              üîÑ <em>Investigating risk profile for selected configuration...</em>
            </p>
          </div>
        </div>
        
        <style>
          @keyframes insight-spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
          }
        </style>
        
        <!-- Roadmap Modal -->
        <div id="roadmapModal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
          <div style="background-color: white; margin: 10% auto; padding: 20px; width: 50%; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.15);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0; color: #1C2541;">Add to Implementation Roadmap</h3>
              <span id="closeRoadmapModal" style="font-size: 28px; cursor: pointer; color: #aaa;">&times;</span>
            </div>
            
            <form action="{{ url_for('roadmap.add_from_control', control_id=control.id) }}" method="post">
              <input type="hidden" name="session_id" value="{{ session_id }}">
              <input type="hidden" name="question_index" value="{{ question_index }}">
              
              <div style="margin-bottom: 20px;">
                <label for="roadmap_id" style="display: block; margin-bottom: 8px; font-weight: 600;">Select Roadmap:</label>
                <select id="roadmap_id" name="roadmap_id" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; color: #1C2541;">
                  <option value="">-- Select a Roadmap --</option>
                  {% set roadmaps = g.get_roadmaps() %}
                  {% if roadmaps %}
                    {% for roadmap in roadmaps %}
                      <option value="{{ roadmap.id }}">{{ roadmap.name }}</option>
                    {% endfor %}
                  {% endif %}
                </select>
                {% if not roadmaps %}
                  <p style="color: #666; font-size: 14px; margin-top: 5px;">
                    No roadmaps available. <a href="{{ url_for('roadmap.create_roadmap') }}" target="_blank" style="color: #00C9A7;">Create one first</a>.
                  </p>
                {% endif %}
              </div>
              
              <div style="margin-bottom: 20px;">
                <label for="priority" style="display: block; margin-bottom: 8px; font-weight: 600;">Priority:</label>
                <select id="priority" name="priority" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; color: #1C2541;">
                  <option value="High" {% if control.risk_level == 'High Risk' %}selected{% endif %}>High</option>
                  <option value="Medium" {% if control.risk_level != 'High Risk' %}selected{% endif %}>Medium</option>
                  <option value="Low">Low</option>
                </select>
              </div>
              
              <div style="display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;">
                <button type="button" id="cancelRoadmapBtn" style="padding: 10px 20px; background-color: transparent; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; font-weight: 600; color: #666;">Cancel</button>
                <button type="submit" style="padding: 10px 20px; background-color: #00C9A7; border: none; color: white; border-radius: 6px; cursor: pointer; font-weight: 600;">Add to Roadmap</button>
              </div>
            </form>
          </div>
        </div>
        
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            // Roadmap Modal
            const roadmapModal = document.getElementById('roadmapModal');
            const addToRoadmapBtn = document.getElementById('addToRoadmapBtn');
            const closeRoadmapModal = document.getElementById('closeRoadmapModal');
            const cancelRoadmapBtn = document.getElementById('cancelRoadmapBtn');
            
            if (addToRoadmapBtn) {
              addToRoadmapBtn.addEventListener('click', function() {
                roadmapModal.style.display = 'block';
              });
            }
            
            if (closeRoadmapModal) {
              closeRoadmapModal.addEventListener('click', function() {
                roadmapModal.style.display = 'none';
              });
            }
            
            if (cancelRoadmapBtn) {
              cancelRoadmapBtn.addEventListener('click', function() {
                roadmapModal.style.display = 'none';
              });
            }
            
            // When the user clicks anywhere outside of the modal, close it
            window.addEventListener('click', function(event) {
              if (event.target == roadmapModal) {
                roadmapModal.style.display = 'none';
              }
            });
            
            // Insight refresh functionality
            const refreshBtn = document.getElementById('refreshInsightBtn');
            const insightContent = document.getElementById('insightContent');
            const insightLoading = document.getElementById('insightLoading');
            const insightSuccess = document.getElementById('insightSuccess');
            
            if (refreshBtn) {
              refreshBtn.addEventListener('click', function() {
                // Show loading state
                if (insightContent) insightContent.style.display = 'none';
                if (insightLoading) insightLoading.style.display = 'block';
                
                // Disable all form controls during loading
                const formControls = document.querySelectorAll('button, select, input, textarea');
                formControls.forEach(control => {
                  control.disabled = true;
                });
                
                // Get control data for the API call
                const controlName = document.querySelector('h2').textContent;
                const categoryElement = document.querySelector('input[name="category"]');
                const category = categoryElement ? categoryElement.value : '';
                
                // Get any risk level that might be in the meta tags
                let riskLevel = 'High'; // Default risk level
                const metaTags = document.querySelectorAll('.meta-tag');
                metaTags.forEach(tag => {
                  if (tag.textContent.includes('Risk:')) {
                    riskLevel = tag.textContent.replace('Risk:', '').trim();
                  }
                });
                
                // Make the actual AJAX call to generate a new insight
                fetch('/generate-insight', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    control_name: controlName,
                    category: category,
                    risk_level: riskLevel,
                    sector: '{{ sector }}',
                    region: '{{ region }}'
                  }),
                })
                .then(response => response.json())
                .then(data => {
                  // Re-enable form controls
                  formControls.forEach(control => {
                    control.disabled = false;
                  });
                  
                  // Update the insight text with the newly generated insight
                  const insightTextElement = document.querySelector('#insightContent p');
                  if (insightTextElement && data.insight) {
                    insightTextElement.innerHTML = '<strong>Life-Wise Insight:</strong> ' + data.insight;
                  }
                  
                  // Show content and success message
                  if (insightContent) insightContent.style.display = 'block';
                  if (insightLoading) insightLoading.style.display = 'none';
                  if (insightSuccess) insightSuccess.style.display = 'block';
                  
                  // Hide success message after 5 seconds
                  setTimeout(function() {
                    if (insightSuccess) insightSuccess.style.display = 'none';
                  }, 5000);
                })
                .catch(error => {
                  console.error('Error generating insight:', error);
                  
                  // Re-enable form controls
                  formControls.forEach(control => {
                    control.disabled = false;
                  });
                  
                  // Show content again without success message
                  if (insightContent) insightContent.style.display = 'block';
                  if (insightLoading) insightLoading.style.display = 'none';
                  
                  // Alert the user about the error
                  alert('Failed to generate a new insight. Please try again.');
                });
              });
            }
          });
        </script>
        
        <!-- Enhanced Evidence & Testing Record Section -->
        <div style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
          <h3 style="margin-bottom: 20px; font-size: 18px; color: #1C2541;">üìÅ Evidence & Testing Record</h3>
          
          <!-- Notes Field (Free Text) -->
          <div style="margin-bottom: 20px;">
            <label for="evidence_notes" style="font-weight: bold; display: block; margin-bottom: 8px;">Notes & Observations:</label>
            <textarea name="evidence_notes" id="evidence_notes" rows="3" cols="50" style="width: 100%; padding: 12px; border: 2px solid #00C9A7; border-radius: 6px; font-family: 'Inter', sans-serif; color: #1C2541;" 
              placeholder="Write evidence notes or observations...">{% if existing_response and existing_response.evidence_notes %}{{ existing_response.evidence_notes }}{% endif %}</textarea>
          </div>
          
          <!-- URL References (Multiple) -->
          <div style="margin-bottom: 20px;">
            <label style="font-weight: bold; display: block; margin-bottom: 8px;">Reference Links:</label>
            <div id="url-container">
              <!-- Initial URL input -->
              <div class="url-input-group" style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="url" name="evidence_urls[]" placeholder="https://example.com/evidence" 
                  style="flex: 1; padding: 10px; border: 2px solid #00C9A7; border-radius: 6px; font-family: 'Inter', sans-serif; color: #1C2541;">
                <button type="button" class="remove-url" style="background-color: #E63946; color: white; border: none; border-radius: 6px; padding: 10px; cursor: pointer; display: none;">
                  <span style="font-weight: bold;">‚úï</span>
                </button>
              </div>
              <!-- Existing URLs will be added here by JavaScript -->
            </div>
            <button type="button" id="add-url-btn" style="background-color: transparent; color: #00C9A7; border: 1px solid #00C9A7; border-radius: 6px; padding: 8px 12px; cursor: pointer; margin-top: 5px; font-size: 14px;">
              + Add another link
            </button>
          </div>
          
          <!-- File Upload -->
          <div style="margin-bottom: 20px;">
            <label for="evidence_files" style="font-weight: bold; display: block; margin-bottom: 8px;">File Evidence:</label>
            <div style="border: 2px dashed #00C9A7; border-radius: 6px; padding: 20px; text-align: center; background-color: rgba(0, 201, 167, 0.05);">
              <input type="file" id="evidence_files" name="evidence_files[]" multiple 
                style="display: none;" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <label for="evidence_files" style="cursor: pointer; display: block;">
                <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;">
                  <span style="font-size: 36px;">üìé</span>
                  <span style="font-weight: 500;">Drag files here or click to browse</span>
                  <span style="font-size: 13px; color: #666;">Accepted formats: PDF, DOCX, Images</span>
                </div>
              </label>
            </div>
            <!-- File list container -->
            <div id="file-list" style="margin-top: 15px;">
              <!-- Uploaded files will appear here -->
            </div>
          </div>
          
          <!-- Date picker for last evidenced/tested date -->
          <div style="margin-bottom: 20px;">
            <label for="evidence_date" style="font-weight: bold; display: block; margin-bottom: 8px;">Last Audited / Evidence Date:</label>
            <input type="date" name="evidence_date" id="evidence_date" 
              style="width: 100%; padding: 10px; border: 2px solid #00C9A7; border-radius: 6px; font-family: 'Inter', sans-serif; color: #1C2541;" 
              value="{% if existing_response and existing_response.evidence_date %}{{ existing_response.evidence_date }}{% endif %}">
            <p style="margin-top: 5px; font-size: 13px; color: #666; font-style: italic;">Enter the most recent date this control was verified, audited, or supported by evidence.</p>
          </div>
          
          <!-- Original Reference Text (keeping for backward compatibility) -->
          <div style="margin-bottom: 20px; display: none;">
            <label for="reference_text" style="font-weight: bold;">Legacy Evidence Reference:</label>
            <textarea name="reference_text" rows="3" cols="50" style="width: 100%;">{% if existing_response %}{{ existing_response.reference_text }}{% endif %}</textarea>
          </div>
        </div>
        
        <!-- JavaScript for Evidence Features -->
        <script>
          document.addEventListener('DOMContentLoaded', function() {
            // URL handling functionality
            const urlContainer = document.getElementById('url-container');
            const addUrlBtn = document.getElementById('add-url-btn');
            
            // Function to add a new URL input
            function addUrlInput(value = '') {
              const urlGroup = document.createElement('div');
              urlGroup.className = 'url-input-group';
              urlGroup.style.display = 'flex';
              urlGroup.style.gap = '10px';
              urlGroup.style.marginBottom = '10px';
              
              const urlInput = document.createElement('input');
              urlInput.type = 'url';
              urlInput.name = 'evidence_urls[]';
              urlInput.placeholder = 'https://example.com/evidence';
              urlInput.value = value;
              urlInput.style.flex = '1';
              urlInput.style.padding = '10px';
              urlInput.style.border = '2px solid #00C9A7';
              urlInput.style.borderRadius = '6px';
              urlInput.style.fontFamily = "'Inter', sans-serif";
              urlInput.style.color = '#1C2541';
              
              const removeBtn = document.createElement('button');
              removeBtn.type = 'button';
              removeBtn.className = 'remove-url';
              removeBtn.style.backgroundColor = '#E63946';
              removeBtn.style.color = 'white';
              removeBtn.style.border = 'none';
              removeBtn.style.borderRadius = '6px';
              removeBtn.style.padding = '10px';
              removeBtn.style.cursor = 'pointer';
              removeBtn.innerHTML = '<span style="font-weight: bold;">‚úï</span>';
              
              removeBtn.addEventListener('click', function() {
                urlContainer.removeChild(urlGroup);
                updateRemoveButtons();
              });
              
              urlGroup.appendChild(urlInput);
              urlGroup.appendChild(removeBtn);
              urlContainer.appendChild(urlGroup);
              
              updateRemoveButtons();
            }
            
            // Function to update remove buttons visibility
            function updateRemoveButtons() {
              const removeButtons = document.querySelectorAll('.remove-url');
              if (removeButtons.length <= 1) {
                removeButtons.forEach(btn => btn.style.display = 'none');
              } else {
                removeButtons.forEach(btn => btn.style.display = 'block');
              }
            }
            
            // Add URL button click handler
            addUrlBtn.addEventListener('click', function() {
              addUrlInput();
            });
            
            // Initialize with existing URLs
            {% if existing_response and existing_response.evidence_urls %}
              {% for url in existing_response.evidence_urls %}
                addUrlInput('{{ url }}');
              {% endfor %}
            {% endif %}
            
            // File upload handling
            const fileInput = document.getElementById('evidence_files');
            const fileList = document.getElementById('file-list');
            const dropZone = fileInput.parentElement.parentElement;
            
            // Handle file selection
            fileInput.addEventListener('change', handleFiles);
            
            // Handle drag and drop
            dropZone.addEventListener('dragover', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dropZone.style.backgroundColor = 'rgba(0, 201, 167, 0.1)';
              dropZone.style.borderColor = '#00C9A7';
            });
            
            dropZone.addEventListener('dragleave', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dropZone.style.backgroundColor = 'rgba(0, 201, 167, 0.05)';
              dropZone.style.borderColor = '#00C9A7';
            });
            
            dropZone.addEventListener('drop', function(e) {
              e.preventDefault();
              e.stopPropagation();
              dropZone.style.backgroundColor = 'rgba(0, 201, 167, 0.05)';
              dropZone.style.borderColor = '#00C9A7';
              
              const dt = e.dataTransfer;
              const files = dt.files;
              fileInput.files = files;
              handleFiles();
            });
            
            function handleFiles() {
              fileList.innerHTML = '';
              
              if (fileInput.files.length > 0) {
                const filesContainer = document.createElement('div');
                filesContainer.style.border = '1px solid #eee';
                filesContainer.style.borderRadius = '6px';
                filesContainer.style.padding = '10px';
                
                const heading = document.createElement('div');
                heading.textContent = 'Selected Files:';
                heading.style.fontWeight = 'bold';
                heading.style.marginBottom = '8px';
                filesContainer.appendChild(heading);
                
                for (let i = 0; i < fileInput.files.length; i++) {
                  const file = fileInput.files[i];
                  const fileItem = document.createElement('div');
                  fileItem.style.display = 'flex';
                  fileItem.style.alignItems = 'center';
                  fileItem.style.gap = '8px';
                  fileItem.style.marginBottom = '5px';
                  
                  // File icon based on type
                  let fileIcon = 'üìÑ';
                  if (file.name.match(/\.(jpg|jpeg|png|gif)$/i)) fileIcon = 'üñºÔ∏è';
                  if (file.name.match(/\.(pdf)$/i)) fileIcon = 'üìï';
                  if (file.name.match(/\.(doc|docx)$/i)) fileIcon = 'üìò';
                  
                  fileItem.innerHTML = `
                    <span>${fileIcon}</span>
                    <span style="flex: 1;">${file.name}</span>
                    <span style="color: #666; font-size: 12px;">${formatFileSize(file.size)}</span>
                  `;
                  
                  filesContainer.appendChild(fileItem);
                }
                
                fileList.appendChild(filesContainer);
              }
            }
            
            function formatFileSize(bytes) {
              if (bytes === 0) return '0 Bytes';
              const k = 1024;
              const sizes = ['Bytes', 'KB', 'MB', 'GB'];
              const i = Math.floor(Math.log(bytes) / Math.log(k));
              return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            // Initialize with existing files
            {% if existing_response and existing_response.evidence_files %}
              // Display existing files if available
              const existingFilesContainer = document.createElement('div');
              existingFilesContainer.style.border = '1px solid #eee';
              existingFilesContainer.style.borderRadius = '6px';
              existingFilesContainer.style.padding = '10px';
              existingFilesContainer.style.marginBottom = '10px';
              
              const heading = document.createElement('div');
              heading.textContent = 'Previously Uploaded Files:';
              heading.style.fontWeight = 'bold';
              heading.style.marginBottom = '8px';
              existingFilesContainer.appendChild(heading);
              
              {% for file in existing_response.evidence_files %}
                const fileItem = document.createElement('div');
                fileItem.style.display = 'flex';
                fileItem.style.alignItems = 'center';
                fileItem.style.gap = '8px';
                fileItem.style.marginBottom = '5px';
                
                // File icon based on type
                let fileIcon = 'üìÑ';
                if ('{{ file.filename }}'.match(/\.(jpg|jpeg|png|gif)$/i)) fileIcon = 'üñºÔ∏è';
                if ('{{ file.filename }}'.match(/\.(pdf)$/i)) fileIcon = 'üìï';
                if ('{{ file.filename }}'.match(/\.(doc|docx)$/i)) fileIcon = 'üìò';
                
                fileItem.innerHTML = `
                  <span>${fileIcon}</span>
                  <span style="flex: 1;">{{ file.filename }}</span>
                  <a href="{{ file.file_path }}" target="_blank" style="color: #00C9A7; text-decoration: none;">View</a>
                `;
                
                existingFilesContainer.appendChild(fileItem);
              {% endfor %}
              
              fileList.appendChild(existingFilesContainer);
            {% endif %}
          });
        </script>
      </div>
      
      <div class="control-info">
        <p><strong>Description:</strong> {{ control.description }}</p>
        
        {% if control.explainability %}
        <p><strong>Explainability:</strong> {{ control.explainability }}</p>
        {% endif %}
        
        {% if control.evidence %}
        <p><strong>Expected Evidence:</strong> {{ control.evidence }}</p>
        {% endif %}
      </div>
      
      {% if control.framework %}
      <div class="framework-section">
        <p><strong>Frameworks Reference:</strong></p>
        <p>{{ control.framework }}</p>
      </div>
      {% endif %}
    </form>
  </div>
</body>
</html>